!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array")):"function"==typeof define&&define.amd?define(["exports","d3-array"],e):e(t.d3=t.d3||{},t.d3Array)}(this,function(t,e){"use strict";function n(){function t(){function t(t){function e(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2),Math.pow(t[1]-e[1],2))}var r,o,i,l=null;t.on("mousedown",function(){r=d3.mouse(document.body),o=+new Date,i=arguments}),t.on("mouseup",function(){e(r,d3.mouse(document.body))>5||(l?(window.clearTimeout(l),l=null,n.apply("dblclick",this,i)):l=window.setTimeout(function(){return function(){n.apply("click",this,i),l=null}}(),300))})}function e(t,e,n){return function(){var r=n.apply(e,arguments);return r===e?t:r}}var n=d3.dispatch("click","dblclick");return function(t,n){for(var r,o=1,i=arguments.length;++o<i;)t[r=arguments[o]]=e(t,n,n[r]);return t}(t,n,"on")}function e(t,e){if(null==t||void 0===t)return void console.log("barcodetree");var o=d3.select(t);if(A=o.select(".container").empty()?o.append("g").attr("class","container"):o.select(".container"),null==N)return 0;if("create"===e){n(N),u=Q(N);for(var l=0;l<u.length;l++){var a=u[l].t_obj,h=a.t_height,f=a.t_width;s<f&&(s=f),v<h&&(v=h)}var y=d3.extent(u,function(t){return+t.depth});if(0===c.length)for(var w=y[0];w<=y[1];w++)c.push(!0);for(var l=0;l<u.length;l++)u[l].collapse_display=!0}for(var l=0;l<u.length;l++)u[l].level_display=c[u[l].depth];return p=d3.scaleLinear().domain([0,s]).range([0,i]),g=d3.scaleLinear().domain([0,v]).range([0,r/5]),d=S(),O(d),C(),E(d)}function n(t){function e(t){if(void 0!==t.children){for(var n=1,r=0,o=0;o<t.children.length;o++){var i=e(t.children[o]);t.children[o].t_obj=i,n+=i.t_width*i.t_height,i.t_height>r&&(r=i.t_height)}r+=1;return{t_width:n/r,t_height:r}}return{t_width:1,t_height:1}}t.t_obj=e(t)}function S(){for(var t=d3.extent(u,function(t){return+t.depth}),e=d3.max(u,function(t){return+t.value}),n=d3.scaleLinear().domain([0,e]).range([0,1]),c=["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],h=[],s=c.length,v=0;v<s;v++)h.push(v/s);var p=d3.scaleLinear().domain(h).range(c);return"bct_w"===x?(0===a.length&&(a=X(i,l,t)),console.log("bctNodeHeight",r),d=U(u,a,r,f,n,p,k)):"bct_h"===x&&(0===a.length&&(a=Y(r,t)),d=V(u,o,a,f,n,p,k)),d}function O(e){var n=t(),r=A.selectAll(".barcodetree-node-g").data(e);r.enter().append("g").attr("class","barcodetree-node-g").attr("id",function(t){return t.name}).attr("transform",function(t,e){return"translate("+t.x+","+t.y+")"}).append("rect").attr("class",function(t,e){var n="barcodetree-node";return void 0!==t.existed&&(t.existed||(n+=" non-existed")),n}).attr("id",function(t){return t.name}).attr("width",function(t){return t.collapse_display&&t.level_display?t.width:0}).attr("height",function(t){return t.height}).attr("fill",function(t){return void 0===t.existed||t.existed?t.color:"white"}).style("stroke",function(t){return y}).style("stroke-width",function(t){if(void 0!==t.existed&&!t.existed){return t.width/5>1?1:t.width/5}return 0}).on("mouseover",function(t,n){R(t,n,e),B(t,n,e),G(t,n,e)}).on("mouseout",function(t,e){P()}).call(n),r.transition().duration(L).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),r.exit().remove();var o=A.selectAll(".barcodetree-node").data(e);o.transition().duration(L).attr("width",function(t){return t.collapse_display&&t.level_display?t.width:0}).attr("height",function(t){return t.height}).attr("fill",function(t){return void 0===t.existed||t.existed?t.color:"white"}).style("stroke",function(t){return y}).style("stroke-width",function(t){if(void 0!==t.existed&&!t.existed){return t.width/5>1?1:t.width/5}return 0}).each(function(t,e){var n=t.name;if(!t.collapse_display||!t.level_display){A.select("#triangle-"+n).remove();var r=h.indexOf(n);-1!==r&&h.splice(r,1)}}),o.exit().remove(),n.on("click",function(){console.log("click"),M()}),n.on("dblclick",function(t,e){console.log("dblclick"),console.log("d",t),W(t,e)})}function W(t,e){for(var n=d[e],r=n.depth,o=t.name,i=h.indexOf(o),l=e+1;l<d.length;l++){if(d[l].depth<=r)break;d[l].collapse_display=-1!==i}-1===i?(h.push(o),q(n)):(h.splice(i,1),H(n)),d=S(),O(d)}function q(t){var e=t.name,n=t.width,r=t.height,o=t.t_obj,i=g(o.t_height),l=p(o.t_width);A.select(".barcodetree-node-g#"+e).append("polygon").attr("class","triangle").attr("id","triangle-"+e).attr("points",function(t){var e=(n-l)/2,o=r,a=r+i;return e+","+a+" "+(e+l/2)+","+o+" "+(e+l)+","+a}).attr("fill","red")}function C(){console.log("update_triangle"),A.selectAll(".triangle").each(function(t,e){console.log("d",t);var n=t.name,r=t.width,o=t.height,i=t.t_obj,l=g(i.t_height),a=p(i.t_width);A.select("#triangle-"+n).transition().duration(L).attr("points",function(t){var e=(r-a)/2,n=o,i=o+l;return e+","+i+" "+(e+a/2)+","+n+" "+(e+a)+","+i})})}function H(t){var e=t.name;A.select(".barcodetree-node-g#"+e).select(".triangle").remove()}function E(t){if(void 0!==t){return t[t.length-1].x+t[t.length-1].width}}function P(t){A.selectAll(".structure-cue").remove()}function R(t,e,n){for(var r=z(t,e,n),o=t.y+t.height,i=o+w+b/2,l=0;l<r.length;l++){var a=r[l],c=a.start_x,d=a.end_x;A.append("line").attr("class","structure-cue").attr("x1",c).attr("y1",i).attr("x2",d).attr("y2",i).style("stroke","red").style("stroke-width",_+"px")}}function z(t,e,n){var r=t.depth,o=r+1,i=[];if(console.log("bctNodeArray",n),j){for(var l=[],a=e+1;a<n.length;a++){var c=n[a];if(c.depth===o&&0!==l.length){var d=K(l);i.push(d),l=[]}if(c.depth===r){if(0!==l.length){var d=K(l);i.push(d),l=[]}break}c.collapse_display&&c.level_display&&l.push(c)}if(0!==l.length){var d=K(l);i.push(d),l=[]}}else{for(var u=[],a=e+1;a<n.length&&(n[a].collapse_display&&c.level_display&&u.push(n[a]),c.depth!==r);a++);var d=K(u);i.push(d)}return i}function B(t,e,n){for(var r=F(t,e,n),o=t.y+t.height,i=o+w+b/2,l=0;l<r.length;l++){var a=r[l],c=a.start_x,d=a.end_x;A.append("line").attr("class","structure-cue").attr("x1",c).attr("y1",i).attr("x2",d).attr("y2",i).style("stroke","red").style("stroke-width",_+"px")}}function F(t,e,n){for(var r=t.depth,o=[],i=e;i>=0;i--){var l=n[i];if(l.depth==r&&l.collapse_display&&l.level_display){var a=[l],c=K(a);o.push(c),r-=1}}return o}function G(t,e,n){for(var r=I(t,e,n),o=t.y+t.height,i=o+w,l=o+w+b,a=0;a<r.length;a++){var c=r[a];A.append("line").attr("class","structure-cue").attr("x1",c).attr("y1",i).attr("x2",c).attr("y2",l).style("stroke","red").style("stroke-width",_+"px")}}function I(t,e,n){for(var r=t.depth,o=t.depth-1,i=[],l=e;l<n.length;l++){var a=n[l];if(a.depth===r&&a.collapse_display&&a.level_display){var c=J(a);i.push(c)}if(a.depth===o)break}for(var l=e-1;l>=0;l--){var a=n[l];if(a.depth===r&&a.collapse_display&&a.level_display){var c=J(a);i.push(c)}if(a.depth===o)break}return i}function J(t){return t.x+t.width/2}function K(t){for(var e=1e7,n=0,r=0;r<t.length;r++){var o=t[r],i=o.x,l=o.x+o.width;i<e&&(e=i),l>n&&(n=l)}return{start_x:e,end_x:n}}function Q(t){function e(t,n){if(n.push(t),void 0!==t.children)for(var r=0;r<t.children.length;r++){var o=t.children[r];e(o,n)}}var n=[];return e(t,n),n}function U(t,e,n,r,o,i,l){for(var a=0,d=0;d<t.length;d++){var u=t[d],h=u.depth,f=u.value;u.height=n,u.width=e[h],u.x=a,u.y=0,u.color=y,"color"===l?u.color=i(o(f)):"height"===l&&(u.height=o(f)*n,u.y=n-u.height),c[h]&&u.collapse_display&&u.level_display&&(a=a+u.width+r)}return t}function V(t,e,n,r,o,i,l){for(var a=0,d=n[0],u=0;u<t.length;u++){var h=t[u],f=h.depth,s=h.value;h.width=e,h.height=n[f],h.x=a,h.y=d-h.height,h.color=y,"color"===l&&(h.color=i(o(s))),c[f]&&h.collapse_display&&h.level_display&&(a=a+h.width+r)}return t}function X(t,e,n){for(var r=[],o=n[1],i=n[1]-n[0],l=(t-e)/i,a=0;a<=o;a++){var c=o-a;r.push(e+l*c)}return r}function Y(t,e){for(var n=[],r=e[1]+1,o=r-e[0],i=t/o,l=0;l<r;l++)n.push(t-i*l);return n}return e.width=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",t):(width=t,e):width},e.height=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",t):(height=t,e):height},e.margin=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for width",margin):(margin=t,e):margin},e.bctNodeHeight=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",r):(r=t,w=.05*r,b=.1*r,_=.025*r,e):r},e.bctNodeWidth=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",o):(o=t,e):o},e.bctRootNodeWidth=function(t){return arguments.length?"number"!=typeof i?void console.warn("invalid value for width",i):(i=t,e):i},e.bctLeafNodeWidth=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",l):(l=t,e):l},e.spacing=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",f):(f=t,e):f},e.colourScheme=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for width",m):(m=t,e):m},e.barcodeTreeType=function(t){return arguments.length?"string"!=typeof t?void console.warn("invalid value for width",x):(x=t,e):x},e.valueEncoding=function(t){return arguments.length?"string"!=typeof t?void console.warn("invalid value for width",k):(k=t,e):k},e.hoveringTrigger=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for width",T):(T=t,e):T},e.unhoveringTrigger=function(t){return arguments.length?"string"!=typeof t?void console.warn("invalid value for width",D):(D=t,e):D},e.clickTrigger=function(t){return arguments.length?"string"!=typeof t?void console.warn("invalid value for width",M):(M=t,e):M},e.structureCueSpacing=function(t){return arguments.length?"number"!=typeof t?void console.warn("invalid value for width",w):(w=t,e):w},e.bctLevelAttrArray=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for width",a):(a=t,e):a},e.bctNodeColor=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for width",y):(y=t,e):y},e.colourScheme=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for colourScheme",m):(m=t,e):m},e.bctLevelDisplayArray=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for bctLevelDisplayArray",c):(c=t,e):c},e.dataset=function(t){return arguments.length?"object"!=typeof t?void console.warn("invalid value for bctLevelDisplayArray",N):(N=t,e):N},e}var r=40,o=10,i=20,l=2,a=[],c=[],d=[],u=[],h=[],f=5,s=0,v=0,p={},g={},y="black",w=.05*r,b=.1*r,_=.025*r,m=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],x="bct_w",k="color",j=!0,A=null,L=1e3,N=null,T=function(){},D=function(){},M=function(){};t.barcodetree=n,Object.defineProperty(t,"__esModule",{value:!0})});